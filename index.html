<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validador de CAF</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3BSBCQELCT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3BSBCQELCT');
  </script>

  <style>
    :root{
      --green:#2e7d32;
      --green-700:#1b5e20;
      --muted:#f5f5f5;
      --ink:#111;
      --panel:#fff;
    }
    *{box-sizing:border-box}
    body{font-family: Arial, Helvetica, sans-serif; color:var(--ink); margin:0; background:#fff}
    .wrap{max-width:980px; margin:auto; padding:40px 20px 90px}

    h1{ color:var(--green); font-size:32px; margin:0 0 8px }
    .lead{ margin:0 0 18px; line-height:1.5 }
    code{ background:#eef7ee; padding:2px 6px; border-radius:6px; }

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:16px 0 24px}
    .link-btn{
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      border:1px solid var(--green); color:var(--green); background:transparent;
      border-radius:999px; padding:8px 14px; font-weight:600;
    }
    .link-btn:hover{ background:var(--green); color:#fff }
    .link-btn svg{ width:18px; height:18px }

    .alert{
      background:#fff8e1;
      border-left:5px solid #ffb300;
      padding:10px 15px;
      margin-bottom:20px;
      font-weight:600;
      font-size:15px;
    }

    .panel{ background:var(--panel); border:1px solid #e7e7e7; border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    input[type="text"]{
      flex:1 1 420px; min-width:260px; padding:12px 16px; font-size:16px;
      border:2px solid var(--green); border-radius:999px; outline:none;
    }
    input[type="text"]:focus{ border-color:var(--green-700) }
    button.primary{
      padding:12px 18px; background:var(--green); color:#fff;
      border:none; border-radius:999px; cursor:pointer; font-weight:700
    }
    button.primary:disabled{ opacity:.6; cursor:not-allowed }
    .hint{ font-size:13px; color:#555; margin-top:8px }

    .stats{ display:flex; gap:12px; align-items:center; margin:14px 0 0; font-size:14px; }
    .badge{
      display:inline-block; background:#eef7ee; color:var(--green);
      border:1px solid var(--green); border-radius:999px; padding:4px 10px; font-weight:600
    }
    .danger{ color:#b00020 }
    .ok{ color:var(--green) }

    /* SEMPRE 1 COLUNA */
    .result .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .item{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:start;
      gap:12px;
      background:var(--muted);
      padding:10px 12px;
      border-radius:10px;
    }

    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:15px;
      white-space: normal;
      overflow: visible;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .actions{ display:flex; gap:8px; }
    .ghost{
      background:transparent; color:var(--green);
      border:1px solid var(--green); border-radius:999px;
      padding:6px 12px; cursor:pointer; font-weight:600;
      min-width:84px; display:inline-flex; align-items:center; justify-content:center;
    }
    .ghost:hover{ background:var(--green); color:#fff }

    .footer-note{ font-size:12px; color:#666; margin-top:18px }

    /* Bot√£o flutuante do WhatsApp estilo original */
    .whatsapp-fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 10000;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #25D366;
      color: #fff;
      text-decoration: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(0,0,0,.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .whatsapp-fab:hover{
      filter: brightness(.95);
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .whatsapp-fab svg{ width: 18px; height: 18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>VALIDADOR DE CAF</h1>
    <div class="alert">
      üì¢ Antes de usar, veja as instru√ß√µes no link abaixo!
    </div>
    <p class="lead">
      Digite o CAF com curingas (<code>*</code>) para gerar combina√ß√µes no servidor. Exemplo:
      <code>BA032025.01.00**39367CAF</code>
    </p>

    <div class="toolbar">
      <a class="link-btn" href="https://drive.google.com/drive/folders/1T4eIs-TP56ZhTrQayJcFTsRPR1m6XUEj?usp=sharing" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        V√≠deo e Manual de Instru√ß√µes
      </a>
      <a class="link-btn" href="https://caf.mda.gov.br/consulta-publica/ufpa" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12a5 5 0 0 1 5-5h3v2h-3a3 3 0 0 0 0 6h3v2h-3a5 5 0 0 1-5-5Zm7-1h2v2h-2v-2Zm3.1-4h3a5 5 0 0 1 0 10h-3v-2h3a3 3 0 0 0 0-6h-3V7Z"/></svg>
        Site oficial de consulta do CAF
      </a>
    </div>

    <div class="panel">
      <div class="row">
        <input 
          id="inputCAF" 
          type="text" 
          placeholder="Ex.: BA032025.01.00**39367CAF"
          maxlength="24"
          pattern="^BA\d{6}\.\d{2}\.[0-9*]{9}CAF$"
          title="Formato v√°lido: BA032025.01.00**39367CAF"
        />
        <button id="btnGerar" class="primary">GERAR CAF</button>
      </div>
      <div class="hint">
        ‚Ä¢ O sistema gera CAF criadas at√© setembro de 2025.
      </div>
      <div class="stats" id="stats"></div>
    </div>

    <div class="result" id="resultado"></div>

    <p class="footer-note">
      Clique na <b>lupa</b> para abrir a consulta com o CAF copiado. <b>Copiar</b> coloca o c√≥digo na √°rea de transfer√™ncia.
    </p>
  </div>

  <!-- Bot√£o flutuante do WhatsApp -->
  <a
    class="whatsapp-fab"
    href="https://wa.me/5575999778739?text=Ol%C3%A1%2C%20solicito%20orienta%C3%A7%C3%A3o%20sobre%20o%20Site%20Validador%20da%20CAF"
    target="_blank" rel="noopener" aria-label="Suporte no WhatsApp"
    title="Suporte no WhatsApp">
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M20.5 3.5A11 11 0 0 0 3.1 17.3L2 22l4.8-1.2A11 11 0 1 0 20.5 3.5Zm-8.6 16a9 9 0 0 1-4.6-1.3l-.3-.2-2.7.7.7-2.6-.2-.3a9 9 0 1 1 7.1 3.7Zm5-6.8c-.3-.2-1.7-.8-1.9-.9s-.4-.1-.6.1-.7.9-.9 1.1-.3.2-.6.1a7.3 7.3 0 0 1-3.3-2 7.1 7.1 0 0 1-1.4-2.5c-.1-.3 0-.4.1-.6l.5-.6c.1-.2.2-.4.3-.6a.6.6 0 0 0 0-.6c0-.2-.6-1.5-.8-2S7.8 4 7.5 4H7a1.2 1.2 0 0 0-.9.4 3.9 3.9 0 0 0-1.2 3c0 1.7 1.2 3.3 1.3 3.6a11.6 11.6 0 0 0 4.4 4.2c.5.2 2 .8 2.7 1s1.7.1 2.3-.1a3.3 3.3 0 0 0 2.2-1.6c.2-.4.2-1 .2-1s-.2-.2-.4-.3Z"/>
    </svg>
    Suporte no WhatsApp
  </a>

  <script>
    const input = document.getElementById('inputCAF');
    const btn = document.getElementById('btnGerar');
    const out = document.getElementById('resultado');
    const stats = document.getElementById('stats');
    const CAF_REGEX = /^BA\d{6}\.\d{2}\.[0-9*]{9}CAF$/;

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style,{
        position:'fixed', right:'16px', bottom:'16px', background:'#333', color:'#fff',
        padding:'8px 12px', borderRadius:'10px', fontSize:'13px', opacity:'0',
        transition:'opacity .2s ease', zIndex:9999
      });
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity='1'; });
      setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),200); },1200);
    }

    function linhaCAF(code){
      const div = document.createElement('div');
      div.className = 'item';

      const left = document.createElement('div');
      left.className = 'code';
      left.textContent = code;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const btnCopy = document.createElement('button');
      btnCopy.className = 'ghost';
      btnCopy.textContent = 'Copiar';
      btnCopy.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(code);
          toast('Copiado!');
        }catch(e){ alert('N√£o foi poss√≠vel copiar.'); }
      });

      const btnLupa = document.createElement('button');
      btnLupa.className = 'ghost';
      btnLupa.innerHTML = 'üîç';
      btnLupa.title = 'Abrir consulta do CAF';
      btnLupa.addEventListener('click', async () => {
        try{ await navigator.clipboard.writeText(code);}catch(_){}
        const url = 'https://caf.mda.gov.br/consulta-publica/ufpa?caf=' + encodeURIComponent(code);
        window.open(url,'_blank','noopener');
      });

      actions.append(btnCopy, btnLupa);
      div.append(left, actions);
      return div;
    }

    input.addEventListener('input', () => {
      const max = parseInt(input.getAttribute('maxlength'), 10) || 24;
      let v = (input.value || '').toUpperCase().replace(/[^A-Z0-9.*]/g, '');
      if (v.length > max) v = v.slice(0, max);
      input.value = v;
      input.setCustomValidity('');
    });

    async function gerar(){
      out.innerHTML = '';
      stats.textContent = 'Processando...';
      btn.disabled = true;

      const caf = (input.value || '').trim().toUpperCase();
      try{
        const resp = await fetch('/api/gerar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ caf })
        });
        const data = await resp.json();

        if(!resp.ok){
          stats.innerHTML = `<span class="badge danger">Erro</span> <span>${data.erro || 'Falha ao gerar.'}</span>`;
          return;
        }

        const unicos = Array.from(new Set(Array.isArray(data.combos) ? data.combos : []));
        stats.innerHTML = `<span class="badge ok">OK</span> <span>Geradas <b>${unicos.length.toLocaleString()}</b> combina√ß√µes.</span>`;

        const grid = document.createElement('div');
        grid.className = 'grid';
        for(const code of unicos){
          grid.appendChild(linhaCAF(code));
        }
        out.appendChild(grid);

      }catch(err){
        stats.innerHTML = `<span class="badge danger">Erro</span> <span>${err.message}</span>`;
      }finally{
        btn.disabled = false;
      }
    }

    // ‚Äî‚Äî‚Äî RASTREAMENTO DE CONSULTAS NO GA4 ‚Äî‚Äî‚Äî
    function trackConsultaCAF(caf) {
      if (window.gtag) {
        gtag('event', 'consulta_caf', {
          caf_mascarado: caf,
          origem: 'validador'
        });
      }
    }

    btn.addEventListener('click', (e) => {
      const value = (input.value || '').toUpperCase().trim();
      if (!CAF_REGEX.test(value)) {
        e.preventDefault();
        input.setCustomValidity('Formato inv√°lido. Use ex: BA032025.01.00**39367CAF. Onde, ap√≥s o BA √© o m√™s e ano de inscri√ß√£o.');
        input.reportValidity();
        return;
      }
      trackConsultaCAF(value); // contabiliza a consulta
      gerar();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btn.click();
      }
    });
  </script>
</body>
</html>
